#include "oled.h"
#include "i2c.h"
#include "tm4c123.h"
#include <stdint.h>

// 6x8点阵ASCII字体(从空格开始 0x20-0x7E)
static const uint8_t F6x8[][6] = {
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00},   // sp
    {0x00, 0x00, 0x00, 0x2f, 0x00, 0x00},   // !
    {0x00, 0x00, 0x07, 0x00, 0x07, 0x00},   // "
    {0x00, 0x14, 0x7f, 0x14, 0x7f, 0x14},   // #
    {0x00, 0x24, 0x2a, 0x7f, 0x2a, 0x12},   // $
    {0x00, 0x23, 0x13, 0x08, 0x64, 0x62},   // %
    {0x00, 0x36, 0x49, 0x55, 0x22, 0x50},   // &
    {0x00, 0x00, 0x05, 0x03, 0x00, 0x00},   // '
    {0x00, 0x00, 0x1c, 0x22, 0x41, 0x00},   // (
    {0x00, 0x00, 0x41, 0x22, 0x1c, 0x00},   // )
    {0x00, 0x14, 0x08, 0x3E, 0x08, 0x14},   // *
    {0x00, 0x08, 0x08, 0x3E, 0x08, 0x08},   // +
    {0x00, 0x00, 0x00, 0xA0, 0x60, 0x00},   // ,
    {0x00, 0x08, 0x08, 0x08, 0x08, 0x08},   // -
    {0x00, 0x00, 0x60, 0x60, 0x00, 0x00},   // .
    {0x00, 0x20, 0x10, 0x08, 0x04, 0x02},   // /
    {0x00, 0x3E, 0x51, 0x49, 0x45, 0x3E},   // 0
    {0x00, 0x00, 0x42, 0x7F, 0x40, 0x00},   // 1
    {0x00, 0x42, 0x61, 0x51, 0x49, 0x46},   // 2
    {0x00, 0x21, 0x41, 0x45, 0x4B, 0x31},   // 3
    {0x00, 0x18, 0x14, 0x12, 0x7F, 0x10},   // 4
    {0x00, 0x27, 0x45, 0x45, 0x45, 0x39},   // 5
    {0x00, 0x3C, 0x4A, 0x49, 0x49, 0x30},   // 6
    {0x00, 0x01, 0x71, 0x09, 0x05, 0x03},   // 7
    {0x00, 0x36, 0x49, 0x49, 0x49, 0x36},   // 8
    {0x00, 0x06, 0x49, 0x49, 0x29, 0x1E},   // 9
    {0x00, 0x00, 0x36, 0x36, 0x00, 0x00},   // :
    {0x00, 0x00, 0x56, 0x36, 0x00, 0x00},   // ;
    {0x00, 0x08, 0x14, 0x22, 0x41, 0x00},   // <
    {0x00, 0x14, 0x14, 0x14, 0x14, 0x14},   // =
    {0x00, 0x00, 0x41, 0x22, 0x14, 0x08},   // >
    {0x00, 0x02, 0x01, 0x51, 0x09, 0x06},   // ?
    {0x00, 0x32, 0x49, 0x59, 0x51, 0x3E},   // @
    {0x00, 0x7C, 0x12, 0x11, 0x12, 0x7C},   // A
    {0x00, 0x7F, 0x49, 0x49, 0x49, 0x36},   // B
    {0x00, 0x3E, 0x41, 0x41, 0x41, 0x22},   // C
    {0x00, 0x7F, 0x41, 0x41, 0x22, 0x1C},   // D
    {0x00, 0x7F, 0x49, 0x49, 0x49, 0x41},   // E
    {0x00, 0x7F, 0x09, 0x09, 0x09, 0x01},   // F
    {0x00, 0x3E, 0x41, 0x49, 0x49, 0x7A},   // G
    {0x00, 0x7F, 0x08, 0x08, 0x08, 0x7F},   // H
    {0x00, 0x00, 0x41, 0x7F, 0x41, 0x00},   // I
    {0x00, 0x20, 0x40, 0x41, 0x3F, 0x01},   // J
    {0x00, 0x7F, 0x08, 0x14, 0x22, 0x41},   // K
    {0x00, 0x7F, 0x40, 0x40, 0x40, 0x40},   // L
    {0x00, 0x7F, 0x02, 0x0C, 0x02, 0x7F},   // M
    {0x00, 0x7F, 0x04, 0x08, 0x10, 0x7F},   // N
    {0x00, 0x3E, 0x41, 0x41, 0x41, 0x3E},   // O
    {0x00, 0x7F, 0x09, 0x09, 0x09, 0x06},   // P
    {0x00, 0x3E, 0x41, 0x51, 0x21, 0x5E},   // Q
    {0x00, 0x7F, 0x09, 0x19, 0x29, 0x46},   // R
    {0x00, 0x46, 0x49, 0x49, 0x49, 0x31},   // S
    {0x00, 0x01, 0x01, 0x7F, 0x01, 0x01},   // T
    {0x00, 0x3F, 0x40, 0x40, 0x40, 0x3F},   // U
    {0x00, 0x1F, 0x20, 0x40, 0x20, 0x1F},   // V
    {0x00, 0x3F, 0x40, 0x38, 0x40, 0x3F},   // W
    {0x00, 0x63, 0x14, 0x08, 0x14, 0x63},   // X
    {0x00, 0x07, 0x08, 0x70, 0x08, 0x07},   // Y
    {0x00, 0x61, 0x51, 0x49, 0x45, 0x43},   // Z
    {0x00, 0x00, 0x7F, 0x41, 0x41, 0x00},   // [
    {0x00, 0x55, 0x2A, 0x55, 0x2A, 0x55},   // 55
    {0x00, 0x00, 0x41, 0x41, 0x7F, 0x00},   // ]
    {0x00, 0x04, 0x02, 0x01, 0x02, 0x04},   // ^
    {0x00, 0x40, 0x40, 0x40, 0x40, 0x40},   // _
    {0x00, 0x00, 0x01, 0x02, 0x04, 0x00},   // '
    {0x00, 0x20, 0x54, 0x54, 0x54, 0x78},   // a
    {0x00, 0x7F, 0x48, 0x44, 0x44, 0x38},   // b
    {0x00, 0x38, 0x44, 0x44, 0x44, 0x20},   // c
    {0x00, 0x38, 0x44, 0x44, 0x48, 0x7F},   // d
    {0x00, 0x38, 0x54, 0x54, 0x54, 0x18},   // e
    {0x00, 0x08, 0x7E, 0x09, 0x01, 0x02},   // f
    {0x00, 0x18, 0xA4, 0xA4, 0xA4, 0x7C},   // g
    {0x00, 0x7F, 0x08, 0x04, 0x04, 0x78},   // h
    {0x00, 0x00, 0x44, 0x7D, 0x40, 0x00},   // i
    {0x00, 0x40, 0x80, 0x84, 0x7D, 0x00},   // j
    {0x00, 0x7F, 0x10, 0x28, 0x44, 0x00},   // k
    {0x00, 0x00, 0x41, 0x7F, 0x40, 0x00},   // l
    {0x00, 0x7C, 0x04, 0x18, 0x04, 0x78},   // m
    {0x00, 0x7C, 0x08, 0x04, 0x04, 0x78},   // n
    {0x00, 0x38, 0x44, 0x44, 0x44, 0x38},   // o
    {0x00, 0xFC, 0x24, 0x24, 0x24, 0x18},   // p
    {0x00, 0x18, 0x24, 0x24, 0x18, 0xFC},   // q
    {0x00, 0x7C, 0x08, 0x04, 0x04, 0x08},   // r
    {0x00, 0x48, 0x54, 0x54, 0x54, 0x20},   // s
    {0x00, 0x04, 0x3F, 0x44, 0x40, 0x20},   // t
    {0x00, 0x3C, 0x40, 0x40, 0x20, 0x7C},   // u
    {0x00, 0x1C, 0x20, 0x40, 0x20, 0x1C},   // v
    {0x00, 0x3C, 0x40, 0x30, 0x40, 0x3C},   // w
    {0x00, 0x44, 0x28, 0x10, 0x28, 0x44},   // x
    {0x00, 0x1C, 0xA0, 0xA0, 0xA0, 0x7C},   // y
    {0x00, 0x44, 0x64, 0x54, 0x4C, 0x44},   // z
};

// 向OLED发送命令
void OLED_WriteCmd(uint8_t cmd) {
    i2c_write_register(OLED_ADDR, OLED_CMD_MODE, cmd);
}

// 向OLED发送数据
void OLED_WriteData(uint8_t data) {
    i2c_write_register(OLED_ADDR, OLED_DATA_MODE, data);
}

// 初始化OLED
void OLED_Init(void) {
    // 初始化I2C总线
    // initI2C();
    
    // 等待OLED启动
    soft_delay(100000);
    
    // 初始化OLED - SSD1306标准初始化序列
    OLED_WriteCmd(0xAE); // 关闭显示
    OLED_WriteCmd(0xD5); // 设置显示时钟分频比/振荡器频率
    OLED_WriteCmd(0x80); // 默认值
    OLED_WriteCmd(0xA8); // 设置多路复用率
    OLED_WriteCmd(0x3F); // 1/64
    OLED_WriteCmd(0xD3); // 设置显示偏移
    OLED_WriteCmd(0x00); // 无偏移
    OLED_WriteCmd(0x40); // 设置显示开始行 [5:0]
    OLED_WriteCmd(0x8D); // 充电泵设置
    OLED_WriteCmd(0x14); // 启用充电泵
    OLED_WriteCmd(0x20); // 设置内存寻址模式
    OLED_WriteCmd(0x02); // 页寻址模式
    // OLED_WriteCmd(0x00); // 水平寻址模式
    OLED_WriteCmd(0xA1); // 设置段重映射
    OLED_WriteCmd(0xC8); // 设置COM输出扫描方向（从上到下）
    OLED_WriteCmd(0xDA); // 设置COM引脚硬件配置
    OLED_WriteCmd(0x12); // 交替COM配置
    OLED_WriteCmd(0x81); // 设置对比度控制
    OLED_WriteCmd(0xCF); // 设置SEG输出电流
    OLED_WriteCmd(0xD9); // 设置预充电周期
    OLED_WriteCmd(0xF1); // 默认值
    OLED_WriteCmd(0xDB); // 设置VCOMH取消选择电平
    OLED_WriteCmd(0x30); // 0.83xVcc
    OLED_WriteCmd(0xA4); // 禁用整个显示开启(黑屏)
    OLED_WriteCmd(0xA6); // 设置正常显示（非反显）
    OLED_WriteCmd(0xAF); // 开启显示
    
    // 清屏
    OLED_Clear();
}

// 开启显示
void OLED_Display_On(void) {
    OLED_WriteCmd(0xAF);
}

// 关闭显示
void OLED_Display_Off(void) {
    OLED_WriteCmd(0xAE);
}

// 清屏
void OLED_Clear(void) {
    uint8_t i, j;
    
    for (i = 0; i < OLED_PAGES; i++) {
        OLED_SetPosition(0, i);
        for (j = 0; j < OLED_WIDTH; j++) {
            OLED_WriteData(0x00);
        }
    }
}

// 设置显示位置
void OLED_SetPosition(uint8_t x, uint8_t y) {
    OLED_WriteCmd(0xB0 + y);                       // 设置页地址
    OLED_WriteCmd(0x10 + ((x & 0xF0) >> 4));       // 设置列高4位地址
    OLED_WriteCmd(0x00 + (x & 0x0F));              // 设置列低4位地址
}

// 显示一个字符
void OLED_ShowChar(uint8_t x, uint8_t y, char chr) {
    uint8_t c = 0, i = 0;
    
    // 超出范围检查
    if (x > OLED_WIDTH - 6 || y > OLED_PAGES - 1) return;
    
    // 计算ASCII字符的偏移量
    c = chr - ' ';
    
    // 设置起始位置
    OLED_SetPosition(x, y);
    
    // 发送字符数据
    for (i = 0; i < 6; i++) {
        OLED_WriteData(F6x8[c][i]);
    }

}

void OLED_ShowString(uint8_t x, uint8_t y, char *str) {
    uint8_t j = 0;
    uint8_t i = 0;
    uint8_t current_x = x;
    uint8_t current_y = y;
    
    while (str[j] != '\0') {
        // 每个字符前明确设置位置
        OLED_SetPosition(current_x, current_y);
        
        uint8_t c = str[j] - ' ';
        
        // 直接写入字符数据
        for (i = 0; i < 6; i++) {
            OLED_WriteData(F6x8[c][i]);
        }
        
        // 更新位置
        current_x += 6;
        
        // 处理换行
        if (current_x > OLED_WIDTH - 6) {
            current_x = 0;
            current_y++;
            if (current_y >= OLED_PAGES) {
                current_y = 0; // 回到第一行
            }
        }
        
        j++;
    }
}



